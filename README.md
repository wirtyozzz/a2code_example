## Техническое задание:
1. Описать взаимодействие основных компонентов платформы OpenStack(привести схемы). Для чего нужен cloud-init?
2. Подготовить пошаговую обезличенную  инструкцию по созданию нового инстанса на платформе OpenStack. 
3. Подготовить пошаговую обезличенную  инструкцию по добавлению и выведению хостов мониторинга Zabbix, добавление метрик. Описать основные подходы автоматизации.

Общее описание:
Данное техническое задание мне будет удобнее всего выполнить перемешав пункты.
Выполнение задание будет выглядить следующим образом:
    - Инструкция по созданию виртуальной машины на базе шаблона *Terraform* с использованием `cloud-init` (`userdata`)
    - Описание взаимодействия компонентов OpenStack на базе задачи по созданию виртуальной машины
    - Введение нового хоста в мониторнги Zabbix


## Решение:

### Создание виртуальной машины
В файле `create_vm.tf` представлен шаблон по созданию
    - Загрузочного диска виртуальной машины размером 50Гб из существующего *image*. Диск не обладает типом
    - Создание виртуальной машины из существующего *flavor* и с добавлением к нему созданного диска как бутового, также машина создается в опередленном *network* и с указанием `cloud-init`(`userdata`)

``` bash
terraform init
```
> Необходимо в случае отсутствия файлов провайдера OpenStack
``` bash
terraform plan
terraform apply
```

Аналогично через openstack-cli
``` bash
source credentials_file
openstack volume create --size 50 --bootable volume_name
openstack server create —flavor some_uuid —image some_uuid —network some_uuid —user-data userdata_file vm_name
openstack server add volume volume_uuid
```

cloud-init - это вынужденный бэкдор запускающийся при создании виртуальной машины. Необходим для прокидывания пользовательской конфигурации на сервер  
cloud-init может выглядить следующим образом и использоваться для прокидывания публичного ключа под пользователя user
``` yaml
#cloud-config
users:
  - name: user
    sudo: 'ALL=(ALL) NOPASSWD:ALL'
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII02O29Uzllkg1NnO3GBvb3EgUyashq+6APdrbFASY1HB user@a2code.ru
```

### Взаимодействие компонентов Openstack
В файле os_vm_creation.drawio схематично описано взаимодействие сервисов при создании виртуальной машины
1. Для создания виртуальной машины в первую очередь необходимо провети аутентификацию и авторизацию пользователя. За это отвечает компонент *keystone*
2. Далее производим запросы к *cinder* для создания диска, и к *nova* для создания виртуальной машины.
3. Так как при создании виртуальной машины мы указываем используемый volume, network, image и flavor - будут сделаны дополнительные запросы к соответствующим сервисам для изменения метадаты/атача объекта по отношению к создаваемому экземпляру вирутальной машины
    - `flavor, image` - glance предоставляет метадату flavor из которого будет создаваться машина и предоставляет образ для создания этой виртуальной машины гипервизору например по PXE
    - `network` - neutron нарезает vlan'ы и создает порт-группу для подкючения к ней виртуальной машины
    - `volume`  - cinder создает диск напрямую на гипервизоре или же предоставляет его гипервизору через например таргет iSCSI 

### Zabbix
#### Введение нового хоста в мониторинг
Введение хоста в мониторинг будет производится путем авторегистрации
Для этого необходимо чтобы на созданном сервере был установлен zabbix-agent. Это выполнимо например при помощи загрузочного образа, *cloud-init*, IAC(*puppet*, *salt*, *ansible*, etc...)
Наличие средств автоматической инсталляции предполагает, что мы также автоматизируем и добавление необходимой конфигурации для нахождения zabbix сервера нашим zabbix-agent

#### Автоматизация, создание метрик и тригеров, шаблоны
На самом zabbix сервер у нас должны быть настроено действие под авторегистрацию, которое добавляет новый хост в нужную нам группу и присваивает хосту необходимый *шаблон* 
> Создание действия
> https://www.zabbix.com/documentation/6.0/ru/manual/config/notifications/action

Шаблон при этом будет содержать метрики и тригеры
Метрики - информация о состоянии какого либо объекта полученная от zabbix-agent 
> Создание метрики
> https://www.zabbix.com/documentation/3.4/ru/manual/config/items/item

Тригеры - правила реагирования на информацию из метрик
> Создание тригеров
> https://www.zabbix.com/documentation/5.2/ru/manual/quickstart/trigger


Шаблон - набор метрик и тригеров
> Cоздание шаблона
> https://www.zabbix.com/documentation/4.2/ru/manual/quickstart/template

После присвоения хосту группы и шаблона, в котором существуют метрики и тригеры - хост введен в мониторинг

#### Выведение хоста из мониторинга
Нативного решения для автоматического удаления у Zabbix нет.
Для автоматизации необходимо прибегать к API Zabbix'а, а конкретнее к host.delete

> https://www.zabbix.com/documentation/current/en/manual/api/reference/host/delete

Например один из вариантов автоматизации: при создании карточки в Jira на выведении хоста из мониторинга будет выполняться скрипт на удаления сабжа (или перевод его в disable)